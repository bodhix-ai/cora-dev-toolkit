# {{PROJECT_NAME}}-infra - Deployment Workflow
# Deploys infrastructure using Terraform
#
# Triggers:
# - Push to main: Deploy to dev
# - Release tags: Deploy to stg/prd with approval

name: Deploy Infrastructure

on:
    push:
        branches:
            - main
        paths:
            - "envs/**"
            - "modules/**"
            - "lambdas/**"
    workflow_dispatch:
        inputs:
            environment:
                description: "Target environment"
                required: true
                default: "dev"
                type: choice
                options:
                    - dev
                    - stg
                    - prd

permissions:
    id-token: write
    contents: read

env:
    AWS_REGION: { { AWS_REGION } }
    TF_VERSION: "1.6.0"

jobs:
    plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        environment: ${{ github.event.inputs.environment || 'dev' }}

        outputs:
            plan_exitcode: ${{ steps.plan.outputs.exitcode }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Init
              working-directory: envs/${{ github.event.inputs.environment || 'dev' }}
              run: terraform init -backend-config=backend.hcl

            - name: Terraform Plan
              id: plan
              working-directory: envs/${{ github.event.inputs.environment || 'dev' }}
              run: |
                  terraform plan -out=tfplan -detailed-exitcode
                  echo "exitcode=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Upload Plan
              uses: actions/upload-artifact@v4
              with:
                  name: tfplan-${{ github.event.inputs.environment || 'dev' }}
                  path: envs/${{ github.event.inputs.environment || 'dev' }}/tfplan

    apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: plan
        if: needs.plan.outputs.plan_exitcode == '2'
        environment: ${{ github.event.inputs.environment || 'dev' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Download Plan
              uses: actions/download-artifact@v4
              with:
                  name: tfplan-${{ github.event.inputs.environment || 'dev' }}
                  path: envs/${{ github.event.inputs.environment || 'dev' }}

            - name: Terraform Init
              working-directory: envs/${{ github.event.inputs.environment || 'dev' }}
              run: terraform init -backend-config=backend.hcl

            - name: Terraform Apply
              working-directory: envs/${{ github.event.inputs.environment || 'dev' }}
              run: terraform apply -auto-approve tfplan
